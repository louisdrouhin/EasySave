<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:EasySave.Models;assembly=EasySave.Models"
             xmlns:converters="clr-namespace:EasySave.Utils.Converters;assembly=EasySave.Utils"
             x:Class="EasySave.GUI.Components.StateCard"
             x:DataType="models:StateEntry">

    <UserControl.Resources>
        <converters:JobStateColorConverter x:Key="JobStateColorConverter"/>
        <converters:SizeProgressConverter x:Key="SizeProgressConverter"/>
        <converters:ProcessedFilesConverter x:Key="ProcessedFilesConverter"/>
    </UserControl.Resources>

    <Border Margin="0,0,0,15" 
            Padding="20" 
            Background="White" 
            CornerRadius="8" 
            BoxShadow="0 2 5 0 #20000000">
        <Grid RowDefinitions="Auto,Auto,Auto">
            <!-- Header: Job Name and Status -->
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="{Binding JobName}" FontSize="18" FontWeight="SemiBold" Foreground="#111827"/>
                    <Border Background="{Binding State, Converter={StaticResource JobStateColorConverter}}" 
                            CornerRadius="4" 
                            Padding="6,2"
                            VerticalAlignment="Center">
                        <TextBlock Text="{Binding State}" FontSize="12" Foreground="White" FontWeight="Medium"/>
                    </Border>
                </StackPanel>
                <TextBlock Grid.Column="1" 
                           Text="{Binding LastActionTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                           FontSize="12" 
                           Foreground="#6B7280"
                           VerticalAlignment="Center"/>
            </Grid>

            <!-- Progress Bar (only if Active) -->
            <StackPanel Grid.Row="1" Margin="0,15,0,0" IsVisible="{Binding Progress, Converter={x:Static ObjectConverters.IsNotNull}}">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Text="Progress" FontSize="14" Foreground="#4B5563"/>
                    <TextBlock Grid.Column="1" Text="{Binding Progress, StringFormat='{}{0:F1}%'}" FontSize="14" FontWeight="Bold" Foreground="#111827"/>
                </Grid>
                <ProgressBar Value="{Binding Progress}" 
                             Minimum="0" 
                             Maximum="100" 
                             Height="8" 
                             Margin="0,5,0,0"
                             Foreground="#22C55E"
                             Background="#E5E7EB"/>
            </StackPanel>

            <!-- Details -->
            <StackPanel Grid.Row="2" Margin="0,15,0,0" Spacing="12">
                <Grid ColumnDefinitions="*,*" IsVisible="{Binding TotalFiles, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Spacing="2">
                        <TextBlock Text="FILES (PROCESSED / TOTAL)" FontSize="10" FontWeight="Bold" Foreground="#9CA3AF"/>
                        <TextBlock FontSize="14" Foreground="#1F2937">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource ProcessedFilesConverter}">
                                    <Binding Path="RemainingFiles" FallbackValue="0"/>
                                    <Binding Path="TotalFiles" FallbackValue="0"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Spacing="2">
                        <TextBlock Text="SIZE (PROCESSED / TOTAL)" FontSize="10" FontWeight="Bold" Foreground="#9CA3AF"/>
                        <TextBlock FontSize="14" Foreground="#1F2937">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource SizeProgressConverter}">
                                    <Binding Path="RemainingSizeToTransfer" FallbackValue="0"/>
                                    <Binding Path="TotalSizeToTransfer" FallbackValue="0"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Grid>

                <StackPanel IsVisible="{Binding CurrentSourcePath, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <TextBlock Text="CURRENT SOURCE" FontSize="10" FontWeight="Bold" Foreground="#9CA3AF"/>
                    <TextBlock Text="{Binding CurrentSourcePath}" FontSize="12" Foreground="#374151" TextWrapping="Wrap" Margin="0,2,0,0"/>
                </StackPanel>
                
                <StackPanel IsVisible="{Binding CurrentDestinationPath, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <TextBlock Text="CURRENT DESTINATION" FontSize="10" FontWeight="Bold" Foreground="#9CA3AF"/>
                    <TextBlock Text="{Binding CurrentDestinationPath}" FontSize="12" Foreground="#374151" TextWrapping="Wrap" Margin="0,2,0,0"/>
                </StackPanel>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>