name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
    tags:
      - "v?[0-9]+.[0-9]+.[0-9]+"
  pull_request:
    branches:
      - main
      - dev

env:
  DOTNET_VERSION: "10.0.102"

jobs:
  test:
    name: Run Unit Tests
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          directory: ./coverage
          fail_ci_if_error: false

  build-and-release:
    name: Build and Create Release
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            RUNTIME_ID: linux-x64
            PLATFORM_NAME: Linux-x64
          - os: windows-latest
            RUNTIME_ID: win-x64
            PLATFORM_NAME: Win-x64
          - os: macos-latest
            RUNTIME_ID: osx-arm64
            PLATFORM_NAME: Mac-arm64

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout Cryptosoft
        uses: actions/checkout@v4
        with:
          repository: louisdrouhin/Cryptosoft
          path: Cryptosoft
          token: ${{ secrets.PAT_CRYPTOSOFT }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract Version
        id: version
        shell: bash
        run: |
          tag="${{ github.ref_name }}"
          version=$(echo "$tag" | sed 's/^v//')
          echo "VERSION=$version" >> $GITHUB_OUTPUT

          if [[ "$version" =~ ^[0-9]+\.0\.0$ ]]; then
              echo "IS_RELEASE=true" >> $GITHUB_OUTPUT
          else
              echo "IS_RELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Restore dependencies
        shell: bash
        run: dotnet restore

      - name: Publish Cryptosoft
        shell: bash
        run: |
          dotnet publish Cryptosoft/Cryptosoft.csproj \
          --configuration Release \
          --runtime ${{ matrix.RUNTIME_ID }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:DebugType=None \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          --output ./publish

      - name: Publish CLI
        shell: bash
        run: |
          dotnet publish EasySave.Cli/EasySave.Cli.csproj \
          --configuration Release \
          --runtime ${{ matrix.RUNTIME_ID }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:DebugType=None \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          --output ./publish

      - name: Publish GUI
        shell: bash
        run: |
          dotnet publish EasySave.Gui/EasySave.Gui.csproj \
          --configuration Release \
          --runtime ${{ matrix.RUNTIME_ID }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:DebugType=None \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          --output ./publish

      - name: Modify config.json for Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: sed -i'' -e 's,"./Cryptosoft.exe","./Cryptosoft",g' ./publish/config.json

      - name: Archive files for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: Compress-Archive -Path ./publish/* -DestinationPath ./EasySave-${{ matrix.PLATFORM_NAME }}-${{ steps.version.outputs.VERSION }}.zip

      - name: Archive files for Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd publish
          zip -r ../EasySave-${{ matrix.PLATFORM_NAME }}-${{ steps.version.outputs.VERSION }}.zip .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: EasySave v${{ steps.version.outputs.VERSION }}
          files: ./EasySave-${{ matrix.PLATFORM_NAME }}-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: ${{ steps.version.outputs.IS_RELEASE == 'false' }}
          make_latest: ${{ steps.version.outputs.IS_RELEASE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
